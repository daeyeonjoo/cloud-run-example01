# This config was automatically generated from your source code
# Stacks detected: deps:java:.,tool:gradle:
version: 2.1

orbs:
  gradle: circleci/gradle@3.0.0

executors:
  default-executor:
    docker:
      - image: cimg/openjdk:21.0
    resource_class: small

feature_branch_only: &feature_branch_only
  filters:
    branches:
      only: /^feature\/.*/

feature_branch_only2: &feature_branch_only2
  filters:
    branches:
      only: /^feature\/.*/

jobs:
  build:
    docker:
      - image: cimg/openjdk:21.0
    steps:
      - checkout
      
      # Setup Docker
      - setup_remote_docker:
          docker_layer_caching: true
          version: 20.10.24
      
      # Install Docker Compose if needed
      - run:
          name: Install Docker Compose
          command: |
            curl -L "https://github.com/docker/compose/releases/download/v2.21.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
            docker-compose --version
      
      # Login to Docker Hub
      - run:
          name: Login to Docker Hub
          command: |
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      
      # Build and push the Docker image
      - run:
          name: Build and push Docker image
          command: |
            # Build the Spring Boot application and create Docker image
            ./gradlew bootBuildImage \
              -PdockerId=$DOCKERHUB_USERNAME \
              -PdockerPassword=$DOCKERHUB_PASSWORD \
              -Porg.gradle.native=true \
              --info
            
            # Tag the image
            docker tag "${DOCKERHUB_USERNAME}/cloud-run-example01:latest" "${DOCKERHUB_USERNAME}/cloud-run-example01:${CIRCLE_SHA1}"
            
            # Push the image to Docker Hub
            docker push "${DOCKERHUB_USERNAME}/cloud-run-example01:latest"
            docker push "${DOCKERHUB_USERNAME}/cloud-run-example01:${CIRCLE_SHA1}"

workflows:
  validate-and-build:
    jobs:
      - build
